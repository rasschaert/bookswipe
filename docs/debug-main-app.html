<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Main App Logic</title>
  </head>
  <body>
    <h1>Debug Main App Logic</h1>
    <div id="status">Testing...</div>
    <div id="console"></div>

    <script>
      const logElement = document.getElementById("console");
      const statusElement = document.getElementById("status");

      function log(message) {
        console.log(message);
        logElement.innerHTML += `<p>${message}</p>`;
      }

      function setStatus(message) {
        statusElement.textContent = message;
      }

      // Copy the exact API class from the main app
      class BookSwipeAPI {
        constructor() {
          this.baseURL = "https://adaptable-oxpecker.pikapod.net";
          this.pb = null;
          this.initialized = false;
        }

        async init() {
          if (this.initialized) return;

          try {
            if (typeof PocketBase === "undefined") {
              await this.loadPocketBaseSDK();
            }
            this.pb = new PocketBase(this.baseURL);
            this.initialized = true;
            log("‚úÖ PocketBase API initialized");
          } catch (error) {
            log(`‚ùå Failed to initialize PocketBase API: ${error.message}`);
            throw error;
          }
        }

        async loadPocketBaseSDK() {
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src =
              "https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js";
            script.onload = () => {
              log("‚úÖ PocketBase SDK loaded from CDN");
              resolve();
            };
            script.onerror = (error) => {
              log(`‚ùå Failed to load PocketBase SDK: ${error}`);
              reject(error);
            };
            document.head.appendChild(script);
          });
        }

        async getBooks() {
          if (!this.initialized || !this.pb) {
            throw new Error(
              "PocketBase API not initialized. Call init() first."
            );
          }

          try {
            const records = await this.pb.collection("books").getFullList({
              sort: "+created",
            });
            log(`üìö Fetched ${records.length} books from PocketBase`);
            return records;
          } catch (error) {
            log(`‚ùå Failed to fetch books: ${error.message}`);
            throw new Error(`Failed to fetch books: ${error.message}`);
          }
        }

        async testConnection() {
          await this.pb.health.check();
          return true;
        }
      }

      async function testMainAppFlow() {
        try {
          setStatus("Step 1: Creating API instance...");
          const bookSwipeAPI = new BookSwipeAPI();
          log("‚úÖ API instance created");

          setStatus("Step 2: Initializing API...");
          await bookSwipeAPI.init();
          log("‚úÖ API initialized");

          setStatus("Step 3: Testing connection...");
          await bookSwipeAPI.testConnection();
          log("‚úÖ Connection test passed");

          setStatus("Step 4: Loading books...");
          const books = await bookSwipeAPI.getBooks();
          log(`‚úÖ Loaded ${books.length} books`);

          if (books.length > 0) {
            log(`First book: ${books[0].title} by ${books[0].author}`);
          }

          setStatus("‚úÖ All tests passed - Main app flow should work!");
        } catch (error) {
          log(`‚ùå Main app flow failed: ${error.message}`);
          log(`Stack trace: ${error.stack}`);
          setStatus(`‚ùå Failed at: ${error.message}`);

          // Try to get more specific error info
          if (error.message.includes("PocketBase")) {
            log("üîç This is a PocketBase-specific error");
          }
          if (error.message.includes("fetch")) {
            log("üîç This is a network/fetch error");
          }
        }
      }

      testMainAppFlow();
    </script>
  </body>
</html>
